---
import BaseLayout from "../layouts/BaseLayout.astro";
const pageTitle = "Unit Arcade";
---

<BaseLayout title={pageTitle}>
  <main class="ua-root" id="uaRoot">

    <!-- SEARCH VIEW -->
    <section id="searchView" class="ua-center">
      <div class="ua-card">
        <h1 class="ua-title">Unit Arcade</h1>
        <p class="ua-sub">Type a unit name and pick from the dropdown.</p>

        <div class="ua-row">
          <div class="ua-field" id="centerField">
            <input
              id="unitSearch"
              class="ua-input"
              type="text"
              placeholder="Search units..."
              autocomplete="off"
              spellcheck="false"
            />
            <div id="unitDropdown" class="ua-dropdown"></div>
          </div>
          <button id="openBtn" class="ua-btn">Open</button>
        </div>

        <p class="ua-footnote">
          Click the search bar to browse units, or type to filter.
        </p>
      </div>
    </section>

    <!-- INFO VIEW -->
    <section id="infoView" class="ua-info">
      <div class="ua-infoWrap">

        <h1 id="unitTitle" class="ua-infoTitle">Unit Arcade</h1>
        <p class="ua-infoSub">Unit details and calculator.</p>

        <div class="ua-panel">
          <div class="ua-panelRow">
            <div>
              <div class="ua-label">Unit search</div>
              <div class="ua-field" id="topField">
                <input
                  id="unitSearchTop"
                  class="ua-input"
                  type="text"
                  placeholder="Search units..."
                  autocomplete="off"
                  spellcheck="false"
                />
                <div id="unitDropdownTop" class="ua-dropdown"></div>
              </div>
              <div class="ua-help">Click to browse or type to filter.</div>
            </div>

            <div class="ua-imageBox">
              <img id="unitImg" class="ua-image" alt="" />
              <div id="unitImgLabel" class="ua-imageText">No image</div>
            </div>
          </div>

          <div class="ua-divider"></div>

          <div class="ua-stats4">
            <div class="ua-stat"><div class="ua-statK">RARITY</div><div id="rarityVal" class="ua-statV">Not set</div></div>
            <div class="ua-stat"><div class="ua-statK">ATTACK TYPE</div><div id="attackVal" class="ua-statV">Not set</div></div>
            <div class="ua-stat"><div class="ua-statK">PLACEMENT PRICE</div><div id="priceVal" class="ua-statV">Not set</div></div>
            <div class="ua-stat"><div class="ua-statK">PLACEMENTS</div><div id="placementsVal" class="ua-statV">Not set</div></div>
          </div>

          <div class="ua-divider"></div>

          <div class="ua-wide">
            <div class="ua-wideK">OBTAINABILITY</div>
            <div id="obtainVal" class="ua-wideV">Not set yet.</div>
          </div>

          <div class="ua-divider"></div>

          <div class="ua-wide">
            <div class="ua-wideK ua-wideK2">
              <span>ABILITY</span>
              <span class="ua-wideRight">DESCRIPTION</span>
            </div>
            <div id="abilityVal" class="ua-wideV">No abilities listed yet.</div>
          </div>
        </div>

        <!-- CALCULATOR -->
        <section class="ua-calc">
          <h2 class="ua-calcTitle">Calculator</h2>

          <div class="ua-calcPanel">
            <div class="ua-calcControls">
              <select id="levelSel" class="ua-select">
                ${Array.from({ length: 10 }, (_, i) => `<option value="${i+1}">Level ${i+1}</option>`).join("")}
              </select>

              <select id="shinySel" class="ua-select">
                <option value="0">Normal</option>
                <option value="1">Shiny</option>
              </select>

              <select id="enchantSel" class="ua-select">
                <option value="none">Enchant: None</option>
                <option value="dmg">DMG +20%</option>
                <option value="cd">CD -20%</option>
                <option value="rng">RNG +20%</option>
              </select>

              <select id="chipSel" class="ua-select">
                <option value="none">Chip: None</option>
                <option value="dmg">DMG +30%</option>
                <option value="cd">CD -15%</option>
              </select>
            </div>

            <div class="ua-calcGrid">
              <div class="ua-calcStat"><div class="ua-calcK">Damage</div><div id="calcDmg" class="ua-calcV">-</div></div>
              <div class="ua-calcStat"><div class="ua-calcK">Cooldown</div><div id="calcCd" class="ua-calcV">-</div></div>
              <div class="ua-calcStat"><div class="ua-calcK">DPS</div><div id="calcDps" class="ua-calcV">-</div></div>
              <div class="ua-calcStat"><div class="ua-calcK">Range</div><div id="calcRng" class="ua-calcV">-</div></div>
            </div>
          </div>
        </section>

      </div>
    </section>
  </main>

  <script is:inline>
    const UNIT_NAMES = ["Bear5","Golden Bonnie","Freddy","Bonnie","Foxy","Chica"];

    const UNIT_DATA = {
      "Bear5": { id:"bear5", rarity:"Uncommon", attack:"Single", price:"250", placements:"6", obtain:"Merchant / Summons", ability:"None", dmg:35.35, cd:2.5, rng:20 },
      "Golden Bonnie": { id:"golden-bonnie", rarity:"Mythic", attack:"Pierce + Poison", price:"4500", placements:"2", obtain:"Event", ability:"Not set", dmg:50.5, cd:2.0, rng:27.5 }
    };

    const html = document.documentElement;
    const body = document.body;

    const searchView = document.getElementById("searchView");
    const infoView = document.getElementById("infoView");

    const unitSearch = document.getElementById("unitSearch");
    const unitSearchTop = document.getElementById("unitSearchTop");
    const unitDropdown = document.getElementById("unitDropdown");
    const unitDropdownTop = document.getElementById("unitDropdownTop");

    const openBtn = document.getElementById("openBtn");

    const unitTitle = document.getElementById("unitTitle");
    const unitImg = document.getElementById("unitImg");
    const unitImgLabel = document.getElementById("unitImgLabel");

    const rarityVal = document.getElementById("rarityVal");
    const attackVal = document.getElementById("attackVal");
    const priceVal = document.getElementById("priceVal");
    const placementsVal = document.getElementById("placementsVal");
    const obtainVal = document.getElementById("obtainVal");
    const abilityVal = document.getElementById("abilityVal");

    const levelSel = document.getElementById("levelSel");
    const shinySel = document.getElementById("shinySel");
    const enchantSel = document.getElementById("enchantSel");
    const chipSel = document.getElementById("chipSel");

    const calcDmg = document.getElementById("calcDmg");
    const calcCd = document.getElementById("calcCd");
    const calcDps = document.getElementById("calcDps");
    const calcRng = document.getElementById("calcRng");

    let currentUnit = null;

    function lockScroll(){ html.classList.add("ua-lock"); body.classList.add("ua-lock"); }
    function unlockScroll(){ html.classList.remove("ua-lock"); body.classList.remove("ua-lock"); }

    function showDropdown(input, menu, pick){
      const q = input.value.toLowerCase();
      const list = UNIT_NAMES.filter(n=>n.toLowerCase().includes(q)).slice(0,10);
      menu.innerHTML = "";
      list.forEach(n=>{
        const b=document.createElement("button");
        b.className="ua-ddItem";
        b.textContent=n;
        b.onclick=()=>pick(n);
        menu.appendChild(b);
      });
      menu.style.display="flex";
    }

    function attach(input, menu, pick){
      input.onfocus=()=>showDropdown(input,menu,pick);
      input.oninput=()=>showDropdown(input,menu,pick);
      input.onkeydown=e=>{ if(e.key==="Escape") menu.style.display="none"; };
    }

    function loadUnit(name){
      if(!UNIT_DATA[name]) return;
      currentUnit = UNIT_DATA[name];

      searchView.style.display="none";
      infoView.style.display="block";
      unlockScroll();

      unitTitle.textContent=name;
      rarityVal.textContent=currentUnit.rarity;
      attackVal.textContent=currentUnit.attack;
      priceVal.textContent=currentUnit.price;
      placementsVal.textContent=currentUnit.placements;
      obtainVal.textContent=currentUnit.obtain;
      abilityVal.textContent=currentUnit.ability;

      unitImg.src=`/units/${currentUnit.id}.png`;
      unitImg.onerror=()=>unitImgLabel.textContent="No image";
      unitImgLabel.textContent="";

      compute();
    }

    function compute(){
      if(!currentUnit) return;
      let dmg=currentUnit.dmg*(1+(levelSel.value-1)*0.06);
      let cd=currentUnit.cd;
      let rng=currentUnit.rng;

      if(shinySel.value==="1") dmg*=1.15;
      if(enchantSel.value==="dmg") dmg*=1.2;
      if(enchantSel.value==="cd") cd*=0.8;
      if(enchantSel.value==="rng") rng*=1.2;
      if(chipSel.value==="dmg") dmg*=1.3;
      if(chipSel.value==="cd") cd*=0.85;

      calcDmg.textContent=dmg.toFixed(2);
      calcCd.textContent=cd.toFixed(3);
      calcDps.textContent=(dmg/cd).toFixed(2);
      calcRng.textContent=rng.toFixed(1);
    }

    openBtn.onclick=()=>loadUnit(unitSearch.value);
    attach(unitSearch,unitDropdown,loadUnit);
    attach(unitSearchTop,unitDropdownTop,loadUnit);

    levelSel.onchange=compute;
    shinySel.onchange=compute;
    enchantSel.onchange=compute;
    chipSel.onchange=compute;

    lockScroll();
    infoView.style.display="none";
  </script>

  <style>
    :global(body){background:transparent!important;}
    :global(body::before){
      content:"";
      position:fixed;
      inset:0;
      z-index:-2;
      background:url("/images/unit-arcade-bg.png") center/cover no-repeat;
      filter:blur(8px) brightness(0.9);
      transform:scale(1.05);
    }
    :global(body::after){
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      background:rgba(5,10,20,0.4);
    }
    :global(html.ua-lock),:global(body.ua-lock){overflow:hidden;height:100%}

    .ua-center{min-height:calc(100vh - 140px);display:grid;place-items:center}
    .ua-card,.ua-panel,.ua-calcPanel{background:rgba(10,15,25,0.6);backdrop-filter:blur(14px);border-radius:18px;border:1px solid rgba(180,210,255,.18)}
    .ua-card{padding:26px;text-align:center}
    .ua-row{display:grid;grid-template-columns:1fr 110px;gap:10px}
    .ua-input,.ua-select{width:100%;padding:14px;border-radius:14px;background:rgba(5,8,15,.6);border:1px solid rgba(180,210,255,.18)}
    .ua-btn{border-radius:14px;background:rgba(25,40,70,.45);border:1px solid rgba(180,210,255,.25);font-weight:900}
    .ua-dropdown{display:none;position:absolute;width:100%;background:rgba(5,8,15,.95);border-radius:14px;padding:10px;max-height:380px;overflow:auto;flex-direction:column;gap:8px}
    .ua-ddItem{padding:12px;border-radius:12px;font-weight:900;text-align:center;background:rgba(255,255,255,.05);border:1px solid rgba(180,210,255,.12)}
    .ua-ddItem:hover{background:rgba(180,210,255,.12)}
    .ua-imageBox{min-height:240px;border-radius:16px;border:1px solid rgba(180,210,255,.18);display:grid;place-items:center}
    .ua-image{width:100%;height:100%;object-fit:cover}
    .ua-calcGrid,.ua-stats4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  </style>
</BaseLayout>
