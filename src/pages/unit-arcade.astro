---
import BaseLayout from "../layouts/BaseLayout.astro";
const pageTitle = "Unit Arcade";
---

<BaseLayout title={pageTitle}>
  <main class="ua-root" id="uaRoot">

    <!-- SEARCH VIEW -->
    <section id="searchView" class="ua-center">
      <div class="ua-card ua-cardBig">
        <h1 class="ua-title">Unit Arcade</h1>
        <p class="ua-sub">
          Type a unit name and press Enter, or click Open.
        </p>

        <div class="ua-row">
          <input
            id="unitSearch"
            class="ua-input ua-inputBig"
            type="text"
            placeholder="Search for a unit..."
            autocomplete="off"
            spellcheck="false"
          />
          <button id="openBtn" class="ua-btn ua-btnBig">Open</button>
        </div>

        <p class="ua-footnote">
          Example: Bear5, Golden Bonnie, Freddy
        </p>
      </div>
    </section>

    <!-- INFO VIEW -->
    <section id="infoView" class="ua-info">
      <div class="ua-infoWrap">

        <h1 id="unitTitle" class="ua-infoTitle">Unit Arcade</h1>
        <p class="ua-infoSub">Unit details and calculator.</p>

        <div class="ua-panel">
          <div class="ua-panelRow">
            <div>
              <div class="ua-label">Search another unit</div>
              <div class="ua-row">
                <input
                  id="unitSearchTop"
                  class="ua-input"
                  type="text"
                  placeholder="Search units..."
                  autocomplete="off"
                  spellcheck="false"
                />
                <button id="openBtnTop" class="ua-btn">Open</button>
              </div>
            </div>

            <div class="ua-imageBox">
              <img id="unitImg" class="ua-image" alt="" />
              <div id="unitImgLabel" class="ua-imageText">No image</div>
            </div>
          </div>

          <div class="ua-divider"></div>

          <div class="ua-stats4">
            <div class="ua-stat"><div class="ua-statK">RARITY</div><div id="rarityVal" class="ua-statV">—</div></div>
            <div class="ua-stat"><div class="ua-statK">ATTACK TYPE</div><div id="attackVal" class="ua-statV">—</div></div>
            <div class="ua-stat"><div class="ua-statK">PLACEMENT PRICE</div><div id="priceVal" class="ua-statV">—</div></div>
            <div class="ua-stat"><div class="ua-statK">PLACEMENTS</div><div id="placementsVal" class="ua-statV">—</div></div>
          </div>

          <div class="ua-divider"></div>

          <div class="ua-wide">
            <div class="ua-wideK">OBTAINABILITY</div>
            <div id="obtainVal" class="ua-wideV">—</div>
          </div>

          <div class="ua-divider"></div>

          <div class="ua-wide">
            <div class="ua-wideK ua-wideK2">
              <span>ABILITY</span>
              <span class="ua-wideRight">DESCRIPTION</span>
            </div>
            <div id="abilityVal" class="ua-wideV">—</div>
          </div>
        </div>

        <!-- CALCULATOR -->
        <section class="ua-calc">
          <h2 class="ua-calcTitle">Calculator</h2>

          <div class="ua-calcPanel">
            <div class="ua-calcControls">
              <select id="levelSel" class="ua-select">
                ${Array.from({ length: 10 }, (_, i) =>
                  `<option value="${i+1}">Level ${i+1}</option>`
                ).join("")}
              </select>

              <select id="shinySel" class="ua-select">
                <option value="0">Normal</option>
                <option value="1">Shiny</option>
              </select>

              <select id="enchantSel" class="ua-select">
                <option value="none">Enchant: None</option>
                <option value="dmg">DMG +20%</option>
                <option value="cd">CD -20%</option>
                <option value="rng">RNG +20%</option>
              </select>

              <select id="chipSel" class="ua-select">
                <option value="none">Chip: None</option>
                <option value="dmg">DMG +30%</option>
                <option value="cd">CD -15%</option>
              </select>
            </div>

            <div class="ua-calcGrid">
              <div class="ua-calcStat"><div class="ua-calcK">Damage</div><div id="calcDmg" class="ua-calcV">—</div></div>
              <div class="ua-calcStat"><div class="ua-calcK">Cooldown</div><div id="calcCd" class="ua-calcV">—</div></div>
              <div class="ua-calcStat"><div class="ua-calcK">DPS</div><div id="calcDps" class="ua-calcV">—</div></div>
              <div class="ua-calcStat"><div class="ua-calcK">Range</div><div id="calcRng" class="ua-calcV">—</div></div>
            </div>
          </div>
        </section>

      </div>
    </section>
  </main>

  <script is:inline>
    const UNIT_DATA = {
      "Bear5": { id:"bear5", rarity:"Uncommon", attack:"Single", price:"250", placements:"6", obtain:"Merchant / Summons", ability:"None", dmg:35.35, cd:2.5, rng:20 },
      "Golden Bonnie": { id:"golden-bonnie", rarity:"Mythic", attack:"Pierce + Poison", price:"4500", placements:"2", obtain:"Event", ability:"Not set", dmg:50.5, cd:2.0, rng:27.5 }
    };

    const html = document.documentElement;
    const body = document.body;

    const searchView = document.getElementById("searchView");
    const infoView = document.getElementById("infoView");

    const unitSearch = document.getElementById("unitSearch");
    const unitSearchTop = document.getElementById("unitSearchTop");
    const openBtn = document.getElementById("openBtn");
    const openBtnTop = document.getElementById("openBtnTop");

    const unitTitle = document.getElementById("unitTitle");
    const unitImg = document.getElementById("unitImg");
    const unitImgLabel = document.getElementById("unitImgLabel");

    const rarityVal = document.getElementById("rarityVal");
    const attackVal = document.getElementById("attackVal");
    const priceVal = document.getElementById("priceVal");
    const placementsVal = document.getElementById("placementsVal");
    const obtainVal = document.getElementById("obtainVal");
    const abilityVal = document.getElementById("abilityVal");

    const levelSel = document.getElementById("levelSel");
    const shinySel = document.getElementById("shinySel");
    const enchantSel = document.getElementById("enchantSel");
    const chipSel = document.getElementById("chipSel");

    const calcDmg = document.getElementById("calcDmg");
    const calcCd = document.getElementById("calcCd");
    const calcDps = document.getElementById("calcDps");
    const calcRng = document.getElementById("calcRng");

    function lockScroll(){ html.classList.add("ua-lock"); body.classList.add("ua-lock"); }
    function unlockScroll(){ html.classList.remove("ua-lock"); body.classList.remove("ua-lock"); }

    function loadUnit(name){
      const unit = UNIT_DATA[name];
      if(!unit) return;

      searchView.style.display="none";
      infoView.style.display="block";
      unlockScroll();

      unitTitle.textContent=name;
      rarityVal.textContent=unit.rarity;
      attackVal.textContent=unit.attack;
      priceVal.textContent=unit.price;
      placementsVal.textContent=unit.placements;
      obtainVal.textContent=unit.obtain;
      abilityVal.textContent=unit.ability;

      unitImg.src=`/units/${unit.id}.png`;
      unitImg.onerror=()=>unitImgLabel.textContent="No image";
      unitImgLabel.textContent="";

      compute(unit);
    }

    function compute(unit){
      let dmg = unit.dmg * (1 + (levelSel.value - 1) * 0.06);
      let cd = unit.cd;
      let rng = unit.rng;

      if(shinySel.value==="1") dmg*=1.15;
      if(enchantSel.value==="dmg") dmg*=1.2;
      if(enchantSel.value==="cd") cd*=0.8;
      if(enchantSel.value==="rng") rng*=1.2;
      if(chipSel.value==="dmg") dmg*=1.3;
      if(chipSel.value==="cd") cd*=0.85;

      calcDmg.textContent=dmg.toFixed(2);
      calcCd.textContent=cd.toFixed(3);
      calcDps.textContent=(dmg/cd).toFixed(2);
      calcRng.textContent=rng.toFixed(1);
    }

    openBtn.onclick=()=>loadUnit(unitSearch.value.trim());
    openBtnTop.onclick=()=>loadUnit(unitSearchTop.value.trim());
    unitSearch.onkeydown=e=>{ if(e.key==="Enter") openBtn.click(); };
    unitSearchTop.onkeydown=e=>{ if(e.key==="Enter") openBtnTop.click(); };

    lockScroll();
    infoView.style.display="none";
  </script>

  <style>
    :global(body){background:transparent!important;}
    :global(body::before){
      content:"";
      position:fixed;
      inset:0;
      z-index:-2;
      background:url("/images/unit-arcade-bg.png") center/cover no-repeat;
      filter:blur(8px) brightness(0.9);
      transform:scale(1.05);
    }
    :global(body::after){
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      background:rgba(5,10,20,0.4);
    }
    :global(html.ua-lock),:global(body.ua-lock){overflow:hidden;height:100%}

    .ua-center{min-height:calc(100vh - 140px);display:grid;place-items:center}
    .ua-cardBig{width:min(900px,100%);padding:40px}
    .ua-inputBig{font-size:1.1rem;padding:18px}
    .ua-btnBig{height:64px;font-size:1.1rem}

    .ua-calcGrid,.ua-stats4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  </style>
</BaseLayout>
