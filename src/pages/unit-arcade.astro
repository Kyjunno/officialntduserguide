---
import BaseLayout from "../layouts/BaseLayout.astro";

const pageTitle = "Unit Arcade";
---

<BaseLayout title={pageTitle}>
  <main class="ua-page">
    <!-- SEARCH-ONLY VIEW -->
    <section id="searchView" class="ua-center">
      <div class="ua-card">
        <h1 class="ua-title">Unit Arcade</h1>
        <p class="ua-sub">Type a unit name and pick from the dropdown.</p>

        <div class="ua-row">
          <div class="ua-field" id="fieldCenter">
            <input
              id="unitSearch"
              class="ua-input"
              type="text"
              placeholder="Search units..."
              autocomplete="off"
              spellcheck="false"
            />
            <div id="unitDropdown" class="ua-dropdown ua-hidden" role="listbox"></div>
          </div>

          <button id="openBtn" class="ua-btn" type="button">Open</button>
        </div>

        <p class="ua-footnote">Click the search bar to browse units, or type to filter.</p>
      </div>
    </section>

    <!-- INFO VIEW -->
    <section id="infoView" class="ua-info ua-hidden">
      <div class="ua-infoWrap">
        <h1 id="unitTitle" class="ua-infoTitle">Unit Arcade</h1>
        <p class="ua-infoSub">Pick a unit to see details.</p>

        <div class="ua-panel">
          <div class="ua-panelRow">
            <div class="ua-panelLeft">
              <div class="ua-label">Unit search</div>

              <div class="ua-field" id="fieldTop">
                <input
                  id="unitSearchTop"
                  class="ua-input"
                  type="text"
                  placeholder="Search units..."
                  autocomplete="off"
                  spellcheck="false"
                />
                <div id="unitDropdownTop" class="ua-dropdown ua-hidden" role="listbox"></div>
              </div>

              <div class="ua-help">Click the search bar to browse, or type to filter.</div>
            </div>

            <div class="ua-imageBox">
              <div id="unitImgLabel" class="ua-imageText">No image</div>
            </div>
          </div>

          <div class="ua-divider"></div>

          <div class="ua-stats4">
            <div class="ua-stat">
              <div class="ua-statK">RARITY</div>
              <div id="rarityVal" class="ua-statV">Not set</div>
            </div>
            <div class="ua-stat">
              <div class="ua-statK">ATTACK TYPE</div>
              <div id="attackVal" class="ua-statV">Not set</div>
            </div>
            <div class="ua-stat">
              <div class="ua-statK">PLACEMENT PRICE</div>
              <div id="priceVal" class="ua-statV">Not set</div>
            </div>
            <div class="ua-stat">
              <div class="ua-statK">PLACEMENTS</div>
              <div id="placementsVal" class="ua-statV">Not set</div>
            </div>
          </div>

          <div class="ua-divider"></div>

          <div class="ua-wide">
            <div class="ua-wideK">OBTAINABILITY</div>
            <div id="obtainVal" class="ua-wideV">Not set yet.</div>
          </div>

          <div class="ua-divider"></div>

          <div class="ua-wide">
            <div class="ua-wideK ua-wideK2">
              <span>ABILITY</span>
              <span class="ua-wideRight">DESCRIPTION</span>
            </div>
            <div id="abilityVal" class="ua-wideV">No abilities listed yet.</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script is:inline>
    const UNIT_NAMES = [
      "Bear5",
      "Test Dummy Endo",
      "Nightguard",
      "Chicken7",
      "Fan",
      "Bonnie",
      "Carl The Cupcake",
      "Freddy",
      "Foxy",
      "Chica",
      "Big Band Bonnie",
      "Golden Bonnie",
      "Bunny6",
      "Sparky The Dog",
      "Endo 01",
      "Bort Bunny",
      "Stuffed Freddy",
      "Phone Guy",
      "Golden Freddy",
      "Fox4",
      "The Amalgamation",
      "Shadow Freddy",
      "Endo Plush",
      "Crying Soul",
      "Lamp"
    ];

    const UNIT_DATA = {
      "Golden Bonnie": {
        rarity: "Mythic",
        attackType: "Pierce + Poison",
        placementPrice: "$4,500",
        placements: "2",
        obtainability: "Not set yet.",
        ability: "Not set yet."
      }
    };

    const searchView = document.getElementById("searchView");
    const infoView = document.getElementById("infoView");

    const fieldCenter = document.getElementById("fieldCenter");
    const unitSearch = document.getElementById("unitSearch");
    const unitDropdown = document.getElementById("unitDropdown");
    const openBtn = document.getElementById("openBtn");

    const fieldTop = document.getElementById("fieldTop");
    const unitSearchTop = document.getElementById("unitSearchTop");
    const unitDropdownTop = document.getElementById("unitDropdownTop");

    const unitTitle = document.getElementById("unitTitle");
    const unitImgLabel = document.getElementById("unitImgLabel");

    const rarityVal = document.getElementById("rarityVal");
    const attackVal = document.getElementById("attackVal");
    const priceVal = document.getElementById("priceVal");
    const placementsVal = document.getElementById("placementsVal");
    const obtainVal = document.getElementById("obtainVal");
    const abilityVal = document.getElementById("abilityVal");

    function hardLockScroll() {
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
      document.documentElement.style.height = "100%";
      document.body.style.height = "100%";
    }

    function hardUnlockScroll() {
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
      document.documentElement.style.height = "";
      document.body.style.height = "";
    }

    // No scroll until info screen is shown
    hardLockScroll();

    function normalize(s) {
      return (s || "").trim();
    }

    function filterUnits(query) {
      const q = (query || "").trim().toLowerCase();
      if (!q) return UNIT_NAMES.slice(0, 10);
      return UNIT_NAMES.filter(n => n.toLowerCase().includes(q)).slice(0, 10);
    }

    function showMenu(menuEl) {
      menuEl.classList.remove("ua-hidden");
    }

    function hideMenu(menuEl) {
      menuEl.classList.add("ua-hidden");
    }

    function closeAllMenus() {
      hideMenu(unitDropdown);
      hideMenu(unitDropdownTop);
    }

    function renderMenu(menuEl, items, onPick) {
      menuEl.innerHTML = "";

      if (!items.length) {
        const empty = document.createElement("div");
        empty.className = "ua-ddEmpty";
        empty.textContent = "No matches";
        menuEl.appendChild(empty);
        return;
      }

      for (const name of items) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "ua-ddItem";
        btn.textContent = name;
        btn.addEventListener("click", () => {
          onPick(name);
          closeAllMenus();
        });
        menuEl.appendChild(btn);
      }
    }

    function openMenuFor(inputEl, menuEl, onPick) {
      const list = filterUnits(inputEl.value);
      renderMenu(menuEl, list, (name) => {
        inputEl.value = name;
        onPick(name);
      });
      showMenu(menuEl);
    }

    function attachDropdown(inputEl, menuEl, onPick) {
      inputEl.addEventListener("focus", () => {
        closeAllMenus();
        openMenuFor(inputEl, menuEl, onPick);
      });

      inputEl.addEventListener("click", () => {
        closeAllMenus();
        openMenuFor(inputEl, menuEl, onPick);
      });

      inputEl.addEventListener("input", () => {
        openMenuFor(inputEl, menuEl, onPick);
      });

      inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeAllMenus();
          inputEl.blur();
        }

        if (e.key === "Enter") {
          const val = normalize(inputEl.value);
          if (UNIT_NAMES.includes(val)) {
            onPick(val);
            closeAllMenus();
          }
        }
      });

      // When the input loses focus, close the dropdown shortly after
      // (timeout lets clicks on menu items register first)
      inputEl.addEventListener("blur", () => {
        setTimeout(() => {
          // Only close if focus didn't move into the menu itself
          if (!menuEl.contains(document.activeElement)) closeAllMenus();
        }, 120);
      });
    }

    // One global click-away handler that ALWAYS works
    document.addEventListener("pointerdown", (e) => {
      const t = e.target;

      const insideCenter = fieldCenter && fieldCenter.contains(t);
      const insideTop = fieldTop && fieldTop.contains(t);

      if (!insideCenter && !insideTop) closeAllMenus();
    });

    function loadUnit(name) {
      const unitName = normalize(name);

      if (!UNIT_NAMES.includes(unitName)) return;

      // Switch views
      searchView.classList.add("ua-hidden");
      infoView.classList.remove("ua-hidden");
      hardUnlockScroll();

      // Sync top search
      unitTitle.textContent = unitName;
      unitSearchTop.value = unitName;

      const data = UNIT_DATA[unitName] || {};

      rarityVal.textContent = data.rarity || "Not set";
      attackVal.textContent = data.attackType || "Not set";
      priceVal.textContent = data.placementPrice || "Not set";
      placementsVal.textContent = data.placements || "Not set";
      obtainVal.textContent = data.obtainability || "Not set yet.";
      abilityVal.textContent = data.ability || "No abilities listed yet.";

      unitImgLabel.textContent = "No image";
    }

    openBtn.addEventListener("click", () => loadUnit(unitSearch.value));

    attachDropdown(unitSearch, unitDropdown, loadUnit);
    attachDropdown(unitSearchTop, unitDropdownTop, loadUnit);
  </script>

  <style>
    :global(body) {
      background: transparent !important;
    }

    :global(body::before) {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -2;
      background-image: url("/images/unit-arcade-bg.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    :global(body::after) {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background: rgba(5, 10, 20, 0.30);
      pointer-events: none;
    }

    .ua-page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .ua-hidden {
      display: none !important;
    }

    .ua-center {
      min-height: calc(100vh - 140px);
      display: grid;
      place-items: center;
    }

    .ua-card {
      width: min(760px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(180, 210, 255, 0.18);
      background: rgba(10, 15, 25, 0.55);
      backdrop-filter: blur(10px);
      padding: 22px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
      overflow: visible;
    }

    .ua-title {
      margin: 0 0 6px;
      font-size: 2.2rem;
      font-weight: 900;
    }

    .ua-sub {
      margin: 0 0 14px;
      opacity: 0.85;
    }

    .ua-row {
      display: grid;
      grid-template-columns: 1fr 110px;
      gap: 10px;
      align-items: start;
    }

    .ua-field {
      position: relative;
      width: 100%;
      overflow: visible;
    }

    .ua-input {
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(180, 210, 255, 0.18);
      background: rgba(5, 8, 15, 0.55);
      padding: 14px 14px;
      outline: none;
      color: inherit;
    }

    .ua-btn {
      border-radius: 14px;
      border: 1px solid rgba(180, 210, 255, 0.20);
      background: rgba(25, 40, 70, 0.35);
      padding: 14px;
      cursor: pointer;
      font-weight: 900;
      height: 52px;
    }

    /* replaces the weird “bar” completely with normal text */
    .ua-footnote {
      margin: 12px 0 0;
      padding: 0;
      background: none;
      border: none;
      border-radius: 0;
      font-size: 0.85rem;
      opacity: 0.7;
    }

    /* DROPDOWN */
    .ua-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      width: 100%;
      z-index: 9999;

      border-radius: 14px;
      border: 1px solid rgba(180, 210, 255, 0.18);
      background: rgba(5, 8, 15, 0.94);
      backdrop-filter: blur(10px);

      max-height: 360px;
      overflow-y: auto;
      overflow-x: hidden;

      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.45);

      display: flex !important;
      flex-direction: column !important;
      align-items: stretch !important;
      gap: 0 !important;
      padding: 8px !important;
    }

    .ua-ddItem {
      display: block !important;
      width: 100% !important;

      margin: 0 !important;
      padding: 12px 12px !important;

      border: 1px solid rgba(180, 210, 255, 0.10) !important;
      border-radius: 12px !important;

      background: rgba(255, 255, 255, 0.04) !important;
      color: inherit !important;

      cursor: pointer !important;

      font-weight: 900 !important;
      font-size: 1.05rem !important;

      text-align: center !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
    }

    .ua-ddItem + .ua-ddItem {
      margin-top: 8px !important;
    }

    .ua-ddItem:hover {
      background: rgba(180, 210, 255, 0.10) !important;
      border-color: rgba(180, 210, 255, 0.22) !important;
    }

    .ua-ddEmpty {
      padding: 12px 12px;
      text-align: center;
      opacity: 0.65;
      font-weight: 800;
    }

    /* INFO VIEW STYLES */
    .ua-infoWrap {
      padding-bottom: 72px;
    }

    .ua-infoTitle {
      margin: 0 0 6px;
      font-size: 2.2rem;
      font-weight: 900;
    }

    .ua-infoSub {
      margin: 0 0 18px;
      opacity: 0.85;
    }

    .ua-panel {
      border-radius: 18px;
      border: 1px solid rgba(180, 210, 255, 0.18);
      background: rgba(10, 15, 25, 0.55);
      backdrop-filter: blur(10px);
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
      overflow: visible;
    }

    .ua-panelRow {
      display: grid;
      grid-template-columns: 1fr 120px;
      gap: 16px;
      align-items: stretch;
    }

    .ua-label {
      font-size: 0.85rem;
      font-weight: 800;
      letter-spacing: 0.04em;
      opacity: 0.9;
      margin-bottom: 10px;
      text-align: left;
    }

    .ua-help {
      margin-top: 10px;
      font-size: 0.8rem;
      opacity: 0.65;
      text-align: left;
    }

    .ua-imageBox {
      border-radius: 16px;
      border: 1px solid rgba(180, 210, 255, 0.18);
      background: rgba(5, 8, 15, 0.35);
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .ua-imageText {
      opacity: 0.7;
      font-weight: 700;
    }

    .ua-divider {
      height: 1px;
      background: rgba(180, 210, 255, 0.14);
      margin: 18px 0;
    }

    .ua-stats4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .ua-stat {
      border-radius: 14px;
      border: 1px solid rgba(180, 210, 255, 0.14);
      background: rgba(5, 8, 15, 0.35);
      padding: 12px;
    }

    .ua-statK {
      font-size: 0.72rem;
      font-weight: 900;
      letter-spacing: 0.06em;
      opacity: 0.75;
    }

    .ua-statV {
      margin-top: 8px;
      font-weight: 800;
    }

    .ua-wide {
      border-radius: 14px;
      border: 1px solid rgba(180, 210, 255, 0.14);
      background: rgba(5, 8, 15, 0.35);
      padding: 14px;
    }

    .ua-wideK {
      font-size: 0.72rem;
      font-weight: 900;
      letter-spacing: 0.06em;
      opacity: 0.75;
      margin-bottom: 10px;
    }

    .ua-wideK2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .ua-wideRight {
      text-align: center;
    }

    .ua-wideV {
      font-weight: 700;
      opacity: 0.9;
    }

    @media (max-width: 900px) {
      .ua-row {
        grid-template-columns: 1fr;
      }
      .ua-panelRow {
        grid-template-columns: 1fr;
      }
      .ua-stats4 {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</BaseLayout>
